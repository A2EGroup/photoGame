<script>
  function refresh() {
    var user = elem('user').innerHTML
    var pw = elem('pw').innerHTML
    dashLoading(true)
    link(server()+"?action=refresh&user="+user+"&pass="+pw,refresh2)
  }

  function refresh2(data) {
    elem('detailsTable').innerHTML=""
    addToTable('detailsTable',data.details)
    elem('activityTable').innerHTML=""
    addToTable('activityTable',data.activity)
    elem('subsTable').innerHTML=""
    addToTable('subsTable',data.subs)
    var rows = elem('subsTable').children
    for (var i = 0; i < rows.length; i++) {
      var email = rows[i].children[0].innerHTML
      var td = document.createElement('td')
      var mail = 'mailto:'+email
      var remove = 'removeSub('+email+')'
      td.innerHTML = '<a href="'+mail+'" uk-icon="mail"></a> <a href="" onclick="'+remove+'" uk-icon="trash"></a>'
      rows[i].appendChild(td)
    }
    dashLoading(false)
  }

  function removeSub(email) {

  }

  function addToTable(id, data) {
    var table = elem(id)
    for (var i = 0; i<data.length; i++) {
      var tr = document.createElement('tr')
      for (var j = 0; j<data[i].length; j++) {
        var td = document.createElement('td')
        td.innerHTML = data[i][j]
        tr.appendChild(td)
      }
    }
  }

  function dashLoading(loading) {
    var preLoadingElems = document.getElementsByClassName('dashLoading')
    var postLoadingElems = document.getElementsByClassName('dashLoaded')
    for (var i = 0; i<preLoadingElems.length; i++) {
      if (loading) {
        show(preLoadingElems[i])
      } else {
        hide(preLoadingElems[i])
      }
    }
    for (var i = 0; i<postLoadingElems.length; i++) {
      if (loading) {
        hide(postLoadingElems[i])
      } else {
        show(postLoadingElems[i])
      }
    }
  }

  function numStr(num, decimals) {
    num = Math.round(num)
    for (var i = 0; i<decimals; i++) {
      var divisor = Math.pow(10,decimals - i)
      if (num / divisor == Math.round(num / divisor)) {
        var result = String(num / Math.pow(10,decimals))
        if (num % Math.pow(10,decimals) == 0 && decimals > 0) {
          result += "."
        }
        for (var n = 0; n < (decimals - i); n++) {
          result += "0"
        }
        return result
      }
    }
    return String(num / Math.pow(10,decimals))
  }
  
  function encrypt(string) {
    return CryptoJS.MD5(string)
  }

  function elem(id) {
    return document.getElementById(id)
  }

  function hide(elem) {
    elem.className += " uk-hidden"
  }

  function show(elem) {
    var classes = elem.className
    while (classes.indexOf('uk-hidden') > -1) {
      classes = classes.replace('uk-hidden','')
    }
    elem.className = classes
  }

  function server() {
    return "https://script.google.com/macros/s/AKfycbwIVik-Agw7jDn_12TW-9m7NWTWX1AZwO1KTXZnCNDI0vHQkjj0i6gO2fb7WwiuAb1E/exec"
  }

  function link(url, nextFunction) {
    fetch(url).then(
    function(response) {
      response.json().then(function(data) {
        nextFunction(data)
      })
    }).catch(function(error){
        //alert('Error: '+error)
        return 'Error: '+error
      })
  }
  function randStr(num) {
    var chars = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"]
    var result = ""
    for (var i = 0; i<num; i++) {
      result+= chars[Math.round(Math.random()*(chars.length-1))]
    }
    return result
  }
</script>
